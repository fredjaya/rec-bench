---
title: "Detection condition proportions"
author: "Fred Jaya"
output: 
  html_document:
    theme: spacelab
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = T,
  warning = F,
  fig.width = 8,
  dev = 'png',
  fig.path = "/Users/13444841/GitHub/rec-bench/figs/")

library(dplyr)
library(tidyr)
library(ggplot2)
library(viridis)
library(gridExtra)
library(cowplot)
library(scales)

theme_fj <- theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 10),
        legend.title = element_text(size = 10))

# Set colour pallete
pal <- c(TP = '#054A91', FP = '#6BA3DB', TN = '#BB342F', FN = '#DE6C68')
```

## Data prep

```{r phi_prep}
phi <- 
  read.csv("~/Dropbox/Masters/02_working/2105_pub/F1_profile_conditions.csv") %>%
  mutate(condition = factor(condition, levels = c("TP", "FP", "TN", "FN"))) %>%
  mutate(rec = scientific(rec))

# Frequency of each condition, per sequence
table(phi$condition)
```

```{r 3seq_prep}
# Read in condition data from rec-bench --class
scores_3seq <-
  read.csv("~/Dropbox/Masters/02_working/2105_pub/F2_3seq_conditions.csv") %>%
  mutate(RC_seq = factor(RC_seq, levels = c("TP", "FP", "TN", "FN"))) %>%
  mutate(rec = scientific(rec))

# Frequency of each condition per sequence
table(scores_3seq$RC_seq, useNA = "ifany") 
```

```{r gc_prep}
# Read gc conditions
gc_conditions <- 
  read.csv("~/Dropbox/Masters/02_working/2105_pub/F3_geneconv_conditions.csv") %>%
  mutate(RC_seq = factor(RC_seq, levels = c("TP", "FP", "TN", "FN")))

# Read in traces to identify GENECONV runs that were not successful (too few polymorphisms)
gc_trace <-
  read.csv("~/Dropbox/Masters/02_working/2105_pub/tracing/trace.csv") %>%
  filter(status == "FAILED") %>%
  # Separate method and parameters into individual columns
  separate(col = name, into = c('name', 'params'), sep = ' \\(')

# Clean parameters for plotting
gc_trace$params <- gsub('[a-z]', '', gc_trace$params)
gc_trace$params <- gsub('^_'   , '', gc_trace$params)
gc_trace$params <- gsub('\\.\\)'   , '', gc_trace$params)

# Separate parameters into individual columns
gc_trace <- 
  gc_trace %>%
  separate(col = params, into = c('mut', 'rec', 'seqn', 'dualInf', 'rep'), 
           sep = '_', remove = T) %>%
  select(c('mut', 'rec', 'seqn', 'dualInf', 'rep')) %>%
  # IDGAF
  mutate(mut = as.numeric(mut),
         rec = as.numeric(rec),
         seqn = as.integer(seqn),
         dualInf = as.integer(dualInf),
         rep = as.numeric(rep))

# Get 15200 rows of non-fails
pass <- 
  gc_conditions %>%
  anti_join(gc_trace, by = c('mut', 'rec', 'rep'))

# Get 5800 rows of fails
fail <- 
  gc_trace %>%
  left_join(gc_conditions, by = c('mut', 'rec', 'rep', 'seqn', 'dualInf'))

# Replace conditions with NAs
fail[7:ncol(fail)] <- NA

# Merge all traces
gc_merged <- rbind(pass, fail) %>%
  mutate(RC_seq = factor(RC_seq, levels = c("TP", "FP", "TN", "FN"))) %>%
  mutate(rec = scientific(rec))

table(gc_merged$RC_seq)
```

## Main figures  

```{r phi_pies, fig.height=4, fig.width=5}
phi %>%
  mutate(mut = factor(mut, levels = c('1', '0.1', '0.01', '0.001', '1e-04', '1e-05', '0'))) %>%
  #mutate(rec = gsub('0e+00', '0', rec)) %>%
  mutate(rec = factor(rec, levels = c('0e+00', '1e-03', '5e-03', '1e-02', '5e-02', '1e-01'))) %>%
  ggplot(aes(x = factor(1), fill = condition)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), switch = 'both') +
  coord_polar(theta = 'y') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'right',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.5, 0),
        plot.tag = element_text(size = 10),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  labs(title = 'a) PhiPack (Profile)',
       x = "Mutation rate", 
       fill = "Per-window\nconditions",
       tag = "Recombination rate")
```

```{r gc_pies, fig.height=4, fig.width=5}
gc_merged %>%
  mutate(mut = factor(mut, levels = c('1', '0.1', '0.01', '0.001', '1e-04', '1e-05', '0'))) %>%
  #mutate(rec = gsub('0e+00', '0', rec)) %>%
  mutate(rec = factor(rec, levels = c('0e+00', '1e-03', '5e-03', '1e-02', '5e-02', '1e-01'))) %>%
  ggplot(aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), switch = 'both') +
  coord_polar(theta = 'y') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'right',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.5, 0),
        plot.tag = element_text(size = 10),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  labs(title = 'c) GENECONV',
       x = "Mutation rate", 
       fill = "Per-sequence\nconditions",
       tag = "Recombination rate")
```

```{r gc_pies, fig.height=6, fig.width=5}
ggplot(data = add_iqrs(gc_merged), 
            aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), 
             switch = 'y') +
  coord_polar(theta = 'y', clip = 'off') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'bottom',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.635, 1.04),
        plot.tag = element_text(size = 11),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  guides(fill = guide_legend(title.position = 'top')) +
  labs(x = "Mutation rate\n(IQR - Pairwise sequence distances)", 
       fill = "Per-window conditions",
       tag = "Recombination rate\n(IQR - Breakpoints per recombinant sequence)")

ggplotly(ggplot(data = add_iqrs(gc_merged), 
            aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), 
             switch = 'y') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'bottom',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.635, 1.04),
        plot.tag = element_text(size = 11),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  guides(fill = guide_legend(title.position = 'top')) +
  labs(x = "Mutation rate\n(IQR - Pairwise sequence distances)", 
       fill = "Per-window conditions",
       tag = "Recombination rate\n(IQR - Breakpoints per recombinant sequence)"))
```

## scratch  

```{r phi_power}
phi_power <- 
  phi %>%
  select(mut, rec, rep, condition) %>%
  group_by(mut, rec, condition, rep) %>%
  tally() %>%
  pivot_wider(names_from = condition, values_from = n) 

phi_power[is.na(phi_power)] <- 0

phi_power <- 
  phi_power %>%
  # True condition
  mutate(TPR = TP / (TP + FN)) %>%
  mutate(FPR = FP / (FP + TN)) %>%
  mutate(TNR = TN / (TN + FP)) %>%
  mutate(FNR = FN / (TP + FN)) %>%
  # Predicted condition positive
  mutate(PPV = TP / (TP + FP)) %>%
  mutate(FDR = FP / (TP + FP)) %>%
  # Predicted condition negative
  mutate(FOR = FN / (TN + FN)) %>%
  mutate(NPV = TN / (TN + FN)) %>%
  # Total population
  mutate(Pre = (TP + FN) / (TP + FP + TN + FN)) %>%
  mutate(ACC = (TP + TN) / (TP + FP + TN + FN)) %>%
  # F-score
  mutate(Fscore = 2 * ((PPV * TPR) / (PPV + TPR))) %>%
  # MCC
  mutate(MCC = ((TP*TN) - (FP*FN)) / sqrt((TP+FP) * (TP+FN) * (TN+FP) * (TN+FN))) %>%
  pivot_longer(cols = TN:MCC, names_to = 'metric', values_to = 'score') %>%
  mutate(metric = factor(metric, levels = c('TPR', 'FPR', 'TNR', 'FNR', 'PPV',
                                            'FDR', 'FOR', 'NPV', 'Pre', 'ACC',
                                            'Fscore', 'MCC', 'TP', 'FP', 'TN', 'FN')))

ggplot(phi_power %>% 
         filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
         mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
         mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
         mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
         mutate(metric = gsub('Fscore', 'F-score', metric)),
  aes(x = as.factor(rec), y = score, fill = as.factor(mut), col = as.factor(mut))) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T) +
  scale_color_viridis(discrete = T, guide = F) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Recombination rate", y = "Score", fill = "Mutation rate",
       title = "PhiPack (Profile)") +
  guides(fill = guide_legend(nrow = 1))
```

```{r phi_power_box, fig.width=7}
phi_box_na <- 
  phi_power %>%
  filter(score == 'NaN') %>%
  mutate(pal = 'grey') %>%
  mutate(score = 0)

phi_box <- 
  phi_power %>%
  filter(score != 'NaN') %>%
  mutate(pal = case_when(
    mut == 0 ~ "#440154FF", 
    mut == 1e-06 ~ "#443A83FF", 
    mut == 1e-05 ~ "#31688EFF",
    mut == 1e-04 ~ "#21908CFF",
    mut == 1e-03 ~ "#35B779FF",
    mut == 1e-02 ~ "#8FD744FF",
    mut == 1     ~ "#FDE725FF")) %>%
  rbind(phi_box_na) %>% 
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric))

ggplot(phi_box, 
       aes(x = as.factor(mut), y = score, fill = as.factor(mut), 
           col = pal)) +
  #geom_boxplot(position = position_dodge2(preserve = 'single'), outlier.alpha = 0) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T, alpha = 0.1) +
  scale_color_identity() +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```

Augment scores so NaNs == 1, as they did what they were supposed to do. e.g. 
TP = 0 and FP = 0 ==> power = 1.

```{r phi_aug, fig.width=7}
phi_aug <- 
  phi_power %>%
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  mutate(score = gsub('NaN', 1, score)) %>%
  mutate(score = as.numeric(score))

ggplot(phi_aug, aes(x = as.factor(mut), y = score, col = as.factor(mut))) +
  #geom_boxplot(position = position_dodge2(preserve = 'single')) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score", title = "GENECONV")
```

```{r phi_aug_means, fig.width=7}
phi_aug_mean <- 
  phi_aug %>%
  group_by(mut, metric) %>%
  summarise(mean = mean(score))

ggplot(phi_aug_mean, aes(x = as.factor(mut), y = mean,
                         group = 1)) +
  geom_line() + 
  geom_point() +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```


```{r 3seq_pie, fig.height=6, fig.width=5}
#write.csv(pie_scores, "3seq_pie_scores.csv")
ggplot(data = add_iqrs(scores_3seq), 
            aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), 
             switch = 'y') +
  coord_polar(theta = 'y', clip = 'off') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'bottom',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.635, 1.04),
        plot.tag = element_text(size = 11),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  guides(fill = guide_legend(title.position = 'top')) +
  labs(x = "Mutation rate\n(IQR - Pairwise sequence distances)", 
       fill = "Per-window conditions",
       tag = "Recombination rate\n(IQR - Breakpoints per recombinant sequence)")

ggplotly(ggplot(data = add_iqrs(scores_3seq), 
            aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), 
             switch = 'y') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'bottom',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.635, 1.04),
        plot.tag = element_text(size = 11),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  guides(fill = guide_legend(title.position = 'top')) +
  labs(x = "Mutation rate\n(IQR - Pairwise sequence distances)", 
       fill = "Per-window conditions",
       tag = "Recombination rate\n(IQR - Breakpoints per recombinant sequence)"))
```

```{r 3seq_power, fig.width=8, fig.height=4}
tseq_power <- 
  scores_3seq %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  pivot_wider(names_from = RC_seq, values_from = n) %>%
  select(-c('NA'))

tseq_power[is.na(tseq_power)] <- 0

tseq_power <- 
  tseq_power %>%
  # As 3SEQ has no TPs
  mutate(TP = NA) %>%
  # True condition
  mutate(TPR = TP / (TP + FN)) %>%
  mutate(FPR = FP / (FP + TN)) %>%
  mutate(TNR = TN / (TN + FP)) %>%
  mutate(FNR = FN / (TP + FN)) %>%
  # Predicted condition positive
  mutate(PPV = TP / (TP + FP)) %>%
  mutate(FDR = FP / (TP + FP)) %>%
  # Predicted condition negative
  mutate(FOR = FN / (TN + FN)) %>%
  mutate(NPV = TN / (TN + FN)) %>%
  # Total population
  mutate(Pre = (TP + FN) / (TP + FP + TN + FN)) %>%
  mutate(ACC = (TP + TN) / (TP + FP + TN + FN)) %>%
  mutate(Fscore = 2 * ((PPV * TPR) / (PPV + TPR))) %>%
  pivot_longer(cols = TN:Fscore, names_to = 'metric', values_to = 'score') %>%
  mutate(metric = factor(metric, levels = c('TPR', 'FPR', 'TNR', 'FNR', 'PPV',
                                            'FDR', 'FOR', 'NPV', 'Pre', 'ACC',
                                            'Fscore', 'TP', 'FP', 'TN', 'FN')))

ggplot(tseq_power %>% 
         filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
         mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
         mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
         mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
         mutate(metric = gsub('Fscore', 'F-score', metric)),
  aes(x = as.factor(rec), y = score, fill = as.factor(mut), col = as.factor(mut))) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T) +
  scale_color_viridis(discrete = T, guide = F) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Recombination rate", y = "Score", fill = "Mutation rate",
       title = '3SEQ') +
  guides(fill = guide_legend(nrow = 1))
```

```{r 3seq_power_box, fig.width=7}
tseq_box_na <- 
  tseq_power %>%
  mutate(score = replace_na('NaN')) %>%
  filter(score == 'NaN') %>%
  mutate(pal = 'grey') %>%
  mutate(score = 0)

tseq_box <- 
  tseq_power %>%
  filter(score != 'NaN') %>%
  mutate(pal = case_when(
    mut == 0 ~ "#440154FF", 
    mut == 1e-06 ~ "#443A83FF", 
    mut == 1e-05 ~ "#31688EFF",
    mut == 1e-04 ~ "#21908CFF",
    mut == 1e-03 ~ "#35B779FF",
    mut == 1e-02 ~ "#8FD744FF",
    mut == 1     ~ "#FDE725FF")) %>%
  rbind(tseq_box_na) %>% 
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric))

ggplot(tseq_box, 
       aes(x = as.factor(mut), y = score, fill = as.factor(mut), 
           col = pal)) +
  #geom_boxplot(position = position_dodge2(preserve = 'single'), outlier.alpha = 0) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T, alpha = 0.1) +
  scale_color_identity() +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```

```{r 3seq_aug, fig.width=7}
tseq_aug <- 
  tseq_power %>%
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  mutate(score = gsub('NaN', 1, score)) %>%
  mutate(score = replace_na(score, 1)) %>%
  mutate(score = as.numeric(score))

paug2 <- ggplot(tseq_aug, aes(x = as.factor(mut), y = score, col = as.factor(mut))) +
  #geom_boxplot(position = position_dodge2(preserve = 'single')) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score", title = "3SEQ")
```

## GENECONV

It is quite odd that GENECONV did not detect more true positives. Possibly, it is difficult to visualise as there are considerably more sequences without recombination simulated. A metric that measures the ability of methods to recover true positives might be useful. This metric is power.

```{r gc_power, fig.width=8, fig.height=4}
gc_power <- 
  gc_merged %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  pivot_wider(names_from = RC_seq, values_from = n) %>%
  select(-c('NA'))

gc_power[is.na(gc_power)] <- 0

gc_power <- 
  gc_power %>%
  # True condition
  mutate(TPR = TP / (TP + FN)) %>%
  mutate(FPR = FP / (FP + TN)) %>%
  mutate(TNR = TN / (TN + FP)) %>%
  mutate(FNR = FN / (TP + FN)) %>%
  # Predicted condition positive
  mutate(PPV = TP / (TP + FP)) %>%
  mutate(FDR = FP / (TP + FP)) %>%
  # Predicted condition negative
  mutate(FOR = FN / (TN + FN)) %>%
  mutate(NPV = TN / (TN + FN)) %>%
  # Total population
  mutate(Pre = (TP + FN) / (TP + FP + TN + FN)) %>%
  mutate(ACC = (TP + TN) / (TP + FP + TN + FN)) %>%
  mutate(Fscore = 2 * ((PPV * TPR) / (PPV + TPR))) %>%
  pivot_longer(cols = TN:Fscore, names_to = 'metric', values_to = 'score') %>%
  mutate(metric = factor(metric, levels = c('TPR', 'FPR', 'TNR', 'FNR', 'PPV',
                                            'FDR', 'FOR', 'NPV', 'Pre', 'ACC',
                                            'Fscore', 'TP', 'FP', 'TN', 'FN')))

ggplot(gc_power %>% 
         filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
         mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
         mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
         mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
         mutate(metric = gsub('Fscore', 'F-score', metric)),
  aes(x = as.factor(rec), y = score, fill = as.factor(mut), col = as.factor(mut))) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T) +
  scale_color_viridis(discrete = T, guide = F) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Recombination rate", y = "Score", fill = "Mutation rate",
       title = "GENECONV") +
  guides(fill = guide_legend(nrow = 1))
```

```{r gc_power_box, fig.width=7}
gc_box_na <- 
  gc_power %>%
  filter(score == 'NaN') %>%
  mutate(pal = 'grey') %>%
  mutate(score = 0)

gc_box <- 
  gc_power %>%
  filter(score != 'NaN') %>%
  mutate(pal = case_when(
    mut == 0 ~ "#440154FF", 
    mut == 1e-06 ~ "#443A83FF", 
    mut == 1e-05 ~ "#31688EFF",
    mut == 1e-04 ~ "#21908CFF",
    mut == 1e-03 ~ "#35B779FF",
    mut == 1e-02 ~ "#8FD744FF",
    mut == 1     ~ "#FDE725FF")) %>%
  rbind(gc_box_na) %>% 
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  arrange()

ggplot(gc_box, 
       aes(x = as.factor(mut), y = score, fill = as.factor(mut), 
           col = pal)) +
  #geom_boxplot(position = position_dodge2(preserve = 'single'), outlier.alpha = 0) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T, alpha = 0.1) +
  scale_color_identity() +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```

```{r gc_aug, fig.width=7}
gc_aug <- 
  gc_power %>%
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  mutate(score = gsub('NaN', 1, score)) %>%
  mutate(score = replace_na(score, 1)) %>%
  mutate(score = as.numeric(score))

paug2 <- ggplot(gc_aug, aes(x = as.factor(mut), y = score, col = as.factor(mut))) +
  #geom_boxplot(position = position_dodge2(preserve = 'single')) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score", title = "GENECONV")
```

## UCHIME

```{r uchime_prep}
# Read uchime conditions
uchime <- 
  read.csv("F4_uchime.csv") %>%
  mutate(RC_seq = factor(RC_seq, levels = c("TP", "FP", "TN", "FN"))) %>%
  mutate(rec = scientific(rec))

table(uchime$RC_seq)
```

```{r uchime_pies, fig.height=6, fig.width=5}
ggplot(data = add_iqrs(uchime), 
            aes(x = factor(1), fill = RC_seq)) +
  theme_fj +
  geom_bar(stat = 'count') +
  facet_grid(cols = vars(rec), rows = vars(mut), 
             switch = 'y') +
  coord_polar(theta = 'y', clip = 'off') +
  scale_fill_manual(na.value = "#F0F0F0", values = pal) +
  theme(axis.text = element_blank(),
        legend.position = 'bottom',
        axis.title.x = element_blank(),
        strip.text.y.left = element_text(angle = 0),
        plot.tag.position = c(0.635, 1.04),
        plot.tag = element_text(size = 11),
        plot.margin = unit(c(5.5, 20, 5.5, 5.5), 'pt')) +
  guides(fill = guide_legend(title.position = 'top')) +
  labs(x = "Mutation rate\n(IQR - Pairwise sequence distances)", 
       fill = "Per-window conditions",
       tag = "Recombination rate\n(IQR - Breakpoints per recombinant sequence)")
```


```{r uchime_power, fig.width=8, fig.height=4}
uchime_power <- 
  uchime %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  pivot_wider(names_from = RC_seq, values_from = n) %>%
  mutate(FP = 0)

uchime_power[is.na(uchime_power)] <- 0

uchime_power <- 
  uchime_power %>%
  # True condition
  mutate(TPR = TP / (TP + FN)) %>%
  mutate(FPR = FP / (FP + TN)) %>%
  mutate(TNR = TN / (TN + FP)) %>%
  mutate(FNR = FN / (TP + FN)) %>%
  # Predicted condition positive
  mutate(PPV = TP / (TP + FP)) %>%
  mutate(FDR = FP / (TP + FP)) %>%
  # Predicted condition negative
  mutate(FOR = FN / (TN + FN)) %>%
  mutate(NPV = TN / (TN + FN)) %>%
  # Total population
  mutate(Pre = (TP + FN) / (TP + FP + TN + FN)) %>%
  mutate(ACC = (TP + TN) / (TP + FP + TN + FN)) %>%
  mutate(Fscore = 2 * ((PPV * TPR) / (PPV + TPR))) %>%
  pivot_longer(cols = TN:MCC, names_to = 'metric', values_to = 'score') %>%
  mutate(metric = factor(metric, levels = c('TPR', 'FPR', 'TNR', 'FNR', 'PPV',
                                            'FDR', 'FOR', 'NPV', 'Pre', 'ACC',
                                            'Fscore', 'TP', 'FP', 'TN', 'FN')))

ggplot(uchime_power %>% 
         filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
         mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
         mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
         mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
         mutate(metric = gsub('Fscore', 'F-score', metric)),
  aes(x = as.factor(rec), y = score, fill = as.factor(mut), col = as.factor(mut))) +
  geom_col(position = position_dodge2(preserve = 'single')) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T) +
  scale_color_viridis(discrete = T, guide = F) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Recombination rate", y = "Score", fill = "Mutation rate",
       title = "UCHIME") +
  guides(fill = guide_legend(nrow = 1))
```

```{r uchime_power_box, fig.width=7}
uchime_box_na <- 
  uchime_power %>%
  filter(score == 'NaN') %>%
  mutate(pal = 'grey') %>%
  mutate(score = 0)

uchime_box <- 
  uchime_power %>%
  filter(score != 'NaN') %>%
  mutate(pal = case_when(
    mut == 0 ~ "#440154FF", 
    mut == 1e-06 ~ "#443A83FF", 
    mut == 1e-05 ~ "#31688EFF",
    mut == 1e-04 ~ "#21908CFF",
    mut == 1e-03 ~ "#35B779FF",
    mut == 1e-02 ~ "#8FD744FF",
    mut == 1     ~ "#FDE725FF")) %>%
  rbind(uchime_box_na) %>% 
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  arrange()

ggplot(uchime_box, 
       aes(x = as.factor(mut), y = score, fill = as.factor(mut), 
           col = pal)) +
  #geom_boxplot(position = position_dodge2(preserve = 'single'), outlier.alpha = 0) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_viridis(discrete = T, alpha = 0.1) +
  scale_color_identity() +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```

```{r uchime_aug, fig.width=7}
uchime_aug <- 
  uchime_power %>%
  filter(metric == 'TPR' | metric == 'TNR' | metric == 'PPV' | metric == 'Fscore') %>%
  mutate(metric = gsub('TPR', 'Power/Recall (TPR)', metric)) %>%
  mutate(metric = gsub('TNR', 'Specificity (TNR)', metric)) %>%
  mutate(metric = gsub('PPV', 'Precision (PPV)', metric)) %>%
  mutate(metric = gsub('Fscore', 'F-score', metric)) %>%
  mutate(score = gsub('NaN', 1, score)) %>%
  mutate(score = replace_na(score, 1)) %>%
  mutate(score = as.numeric(score))

paug3 <- ggplot(uchime_aug, aes(x = as.factor(mut), y = score, col = as.factor(mut))) +
  #geom_boxplot(position = position_dodge2(preserve = 'single')) +
  geom_jitter(alpha = 0.6, width = 0.4, height = 0, shape = 16) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score", title = "UCHIME")
```

## Augmented scores
```{r augmented, fig.width=7}
# 3SEQ
tseq_aug_mean <- 
  tseq_aug %>%
  group_by(mut, metric) %>%
  summarise(mean = mean(score)) %>%
  mutate(Method = '3SEQ')

# GENECONV
gc_aug_mean <- 
  gc_aug %>%
  group_by(mut, metric) %>%
  summarise(mean = mean(score)) %>%
  mutate(Method = 'GENECONV')

# UCHIME and merge
aug_means <- 
  uchime_aug %>%
  group_by(mut, metric) %>%
  summarise(mean = mean(score)) %>%
  mutate(Method = 'UCHIME') %>%
  rbind(tseq_aug_mean, gc_aug_mean)

rm(tseq_aug_mean, gc_aug_mean)

ggplot(aug_means, 
       aes(x = as.factor(mut), y = mean, 
           col = Method, group = interaction(Method))) +
  geom_line() + 
  geom_point() +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  ylim(0, 1) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Mutation rate", y = "Score")
```

```{r augmented_ranges}
aug_merged <- 
  tseq_aug %>%
  rbind(gc_aug, uchime_aug)
  
ggplot(aug_merged, 
       aes(x = as.factor(mut), y = mean, 
           col = Method, group = interaction(Method))) +
  geom_line() + 
  geom_point() +
  stat_summary(geom = "linerange", fun = mean_se) +
  facet_wrap(facets = vars(metric), ncol = 2) +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  ylim(0, 1) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Mutation rate", y = "Score")
```

```{r mcc_phi_prep, fig.width=7}
phi_mcc <- 
  phi %>%
  select(mut, rec, rep, condition) %>%
  group_by(mut, rec, condition, rep) %>%
  tally() %>%
  pivot_wider(names_from = condition, values_from = n)

phi_mcc[is.na(phi_mcc)] <- 0

# Add MCC
phi_mcc <- 
  phi_mcc %>%
  mutate(MCC = ((TP*TN) - (FP*FN)) / sqrt((TP+FP) * (TP+FN) * (TN+FP) * (TN+FN)))

## Correct for NaNs
# Count the number of zero-cases per row
phi_mcc$zero_cases <- 
  apply(phi_mcc[4:7], MARGIN = 1, function(x) length(which(x == 0)))

# Subset rows where there are three zero-cases and correct
phi_mcc_onecase <-
  phi_mcc %>%
  filter(MCC == 'NaN' & zero_cases == 3) %>%
  mutate(MCC = case_when(TP != 0 | TN != 0 ~ 1,
                         FP != 0 | FN != 0 ~ -1))
# Subset rows where there are two zero-cases and correct 
phi_mcc_twocase <- 
  phi_mcc %>%
  filter(MCC == 'NaN' & zero_cases == 2) %>%
  mutate(MCC = 0)

# Remove all rows that were subset for correction and re-join corrected
phi_mcc <- 
  phi_mcc %>%
  filter(MCC != 'NaN') %>%
  rbind(phi_mcc_onecase, phi_mcc_twocase) %>%
  select(-zero_cases)

rm(phi_mcc_onecase, phi_mcc_twocase)

# add normalised MCC
phi_mcc <- 
  phi_mcc %>%
  mutate(normMCC = (MCC +1) / 2)
```

```{r mcc_phi, fig.width=7}
# Plot
ggplot(phi_mcc, 
       aes(x = as.factor(mut), y = normMCC, col = as.factor(mut))) +
  #geom_boxplot(position = position_dodge2(preserve = 'single')) +
  geom_jitter() +
  theme_fj +
  scale_color_viridis(discrete = T) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'none') +
  labs(x = "Mutation rate", y = "Score")
```

```{r mcc_phi_mean, fig.width=7}
# Plot mean
phi_mcc_mean <- 
  phi_mcc %>%
  group_by(mut) %>%
  summarise(mean = mean(normMCC), sd = sd(normMCC)) %>%
  mutate(min_sd = mean - sd, max_sd = mean + sd)
 

ggplot(phi_mcc_mean, aes(x = as.factor(mut), y = mean, group = 1)) +
  geom_ribbon(aes(ymin = min_sd, ymax = max_sd), alpha = 0.2, col = NA, fill = 'grey') +
  geom_point() +
  geom_line() +
  theme_fj +
  #scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Mutation rate", y = "Score")

ggplot(phi_mcc, aes(x = as.factor(mut), y = normMCC, group = interaction(mut))) +
  geom_jitter(shape = 16, alpha = 0.5) +
  stat_summary(geom = 'line', fun = mean, size = 1) +
  stat_summary(geom = 'point', fun = mean) +
  stat_summary(geom = 'pointrange', 
               fun = mean, 
               fun.ymin = function(x) mean(x) - sd(x),
               fun.ymax = function(x) mean(x) + sd(x)) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Mutation rate", y = "Score")
```

```{r mcc_rest_prep, fig.width=7}
# 3SEQ
tseq_mcc <- 
  scores_3seq %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  filter(!is.na(RC_seq)) %>%
  mutate(Method = '3SEQ')

# GENECONV
gc_mcc <- 
  gc_merged %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  filter(!is.na(RC_seq)) %>%
  mutate(Method = 'GENECONV')

# UCHIME and bind all
rest_mcc <- 
  uchime %>%
  select(mut, rec, rep, seq_name, RC_seq) %>%
  group_by(mut, rec, RC_seq, rep) %>%
  tally() %>%
  mutate(Method = 'UCHIME') %>%
  rbind(tseq_mcc, gc_mcc) %>%
  pivot_wider(names_from = RC_seq, values_from = n)
  
rm(tseq_mcc, gc_mcc)
rest_mcc[is.na(rest_mcc)] <- 0

# Add MCC
rest_mcc <- 
  rest_mcc %>%
  mutate(MCC = ((TP*TN) - (FP*FN)) / sqrt((TP+FP) * (TP+FN) * (TN+FP) * (TN+FN)))

## Correct for NaNs
# Count the number of zero-cases per row
rest_mcc$zero_cases <- 
  apply(rest_mcc[5:8], MARGIN = 1, function(x) length(which(x == 0)))

# Subset rows where there are three zero-cases and correct
rest_mcc_onecase <-
  rest_mcc %>%
  filter(MCC == 'NaN' & zero_cases == 3) %>%
  mutate(MCC = case_when(TP != 0 | TN != 0 ~ 1,
                         FP != 0 | FN != 0 ~ -1))
# Subset rows where there are two zero-cases and correct 
rest_mcc_twocase <- 
  rest_mcc %>%
  filter(MCC == 'NaN' & zero_cases == 2) %>%
  mutate(MCC = 0)

# Remove all rows that were subset for correction and re-join corrected
rest_mcc <- 
  rest_mcc %>%
  filter(MCC != 'NaN') %>%
  rbind(rest_mcc_onecase, rest_mcc_twocase) %>%
  select(-zero_cases)

rm(rest_mcc_onecase, rest_mcc_twocase)

# add normalised MCC
rest_mcc <- 
  rest_mcc %>%
  mutate(normMCC = (MCC +1) / 2)
```

```{r mcc_rest, fig.width=7}
# Plot
ggplot(rest_mcc, 
       aes(x = as.factor(mut), y = normMCC)) +
  geom_jitter() +
  theme_fj +
  facet_wrap(vars(Method), ncol = 2) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(col = 'Method', x = "Mutation rate", y = "Score")
```

```{r mcc_rest_mean, fig.width=7}
# Plot mean
rest_mcc_mean <- 
  rest_mcc %>%
  group_by(mut, Method) %>%
  summarise(normMCC = mean(normMCC), sd = sd(normMCC))

ggplot(rest_mcc, 
       aes(x = as.factor(mut), y = normMCC, 
           col = Method, group = interaction(Method),
           fill = Method)) +
  #stat_summary(geom = 'bar', fun = mean, position = position_dodge2(preserve = 'single')) +
  #stat_summary(geom = 'errorbar', fun.data = mean_sdl, fun.args = list(mult = 1), col = 'grey', position = position_dodge2(preserve = 'single')) +
  stat_summary(geom = 'line', fun = mean) +
  stat_summary(geom = 'point', fun = mean) +
  theme_fj +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1)) +
  scale_color_viridis(discrete = T) +
  scale_fill_viridis(discrete = T) +
  theme(panel.border = element_rect(fill = NA, color = 'grey'),
        legend.position = 'bottom') +
  labs(x = "Mutation rate", y = "Score")
```